{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/vs%20code/antigravity%20related%20test%20projects/react%20dashboard%20project/admin-dashboard-type2/app/api/summarize/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\nfunction extractVideoId(url: string): string | null {\r\n  const patterns = [\r\n    /(?:youtube\\.com\\/watch\\?v=)([a-zA-Z0-9_-]{11})/,\r\n    /(?:youtu\\.be\\/)([a-zA-Z0-9_-]{11})/,\r\n    /(?:youtube\\.com\\/embed\\/)([a-zA-Z0-9_-]{11})/,\r\n    /(?:youtube\\.com\\/shorts\\/)([a-zA-Z0-9_-]{11})/,\r\n  ];\r\n\r\n  for (const pattern of patterns) {\r\n    const match = url.match(pattern);\r\n    if (match) return match[1];\r\n  }\r\n  // If input is just the ID (11 chars)\r\n  if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {\r\n    return url;\r\n  }\r\n  return null;\r\n}\r\n\r\ninterface CaptionTrack {\r\n  languageCode: string;\r\n  baseUrl: string;\r\n  name?: { simpleText?: string };\r\n}\r\n\r\ninterface VideoMetadata {\r\n  title: string;\r\n  description: string;\r\n  transcript?: string;\r\n  isFallback: boolean;\r\n}\r\n\r\nasync function getOEmbedMetadata(videoId: string): Promise<{ title: string }> {\r\n  try {\r\n    const resp = await fetch(\r\n      `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`,\r\n    );\r\n    if (resp.ok) {\r\n      const data = await resp.json();\r\n      return { title: data.title || \"Untitled Video\" };\r\n    }\r\n  } catch (err) {\r\n    console.error(\"oEmbed metadata extraction failed:\", err);\r\n  }\r\n  return { title: \"Untitled Video\" };\r\n}\r\n\r\nfunction decodeHtmlEntities(text: string): string {\r\n  return text\r\n    .replace(/&amp;#39;/g, \"'\")\r\n    .replace(/&amp;quot;/g, '\"')\r\n    .replace(/&amp;/g, \"&\")\r\n    .replace(/&#39;/g, \"'\")\r\n    .replace(/&quot;/g, '\"')\r\n    .replace(/&lt;/g, \"<\")\r\n    .replace(/&gt;/g, \">\")\r\n    .replace(/\\n/g, \" \")\r\n    .trim();\r\n}\r\n\r\nasync function getTranscript(videoId: string): Promise<VideoMetadata> {\r\n  // 1. Get official title via oEmbed (most reliable on Vercel)\r\n  const { title: oEmbedTitle } = await getOEmbedMetadata(videoId);\r\n\r\n  // 2. Try YouTube player API with ANDROID client for transcript and description\r\n  let playerResponse;\r\n  try {\r\n    playerResponse = await fetch(\r\n      \"https://www.youtube.com/youtubei/v1/player?prettyPrint=false\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"User-Agent\":\r\n            \"com.google.android.youtube/19.09.37 (Linux; U; Android 13; en_US; SM-S918B; Build/TP1A.220624.014)\",\r\n          \"X-YouTube-Client-Name\": \"3\",\r\n          \"X-YouTube-Client-Version\": \"19.09.37\",\r\n          \"X-Goog-Api-Format-Version\": \"2\",\r\n        },\r\n        body: JSON.stringify({\r\n          videoId,\r\n          context: {\r\n            client: {\r\n              clientName: \"ANDROID\",\r\n              clientVersion: \"19.09.37\",\r\n              androidSdkVersion: 33,\r\n              hl: \"en\",\r\n              gl: \"US\",\r\n            },\r\n          },\r\n        }),\r\n      },\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Player API fetch failed:\", err);\r\n    return { title: oEmbedTitle, description: \"\", isFallback: true };\r\n  }\r\n\r\n  if (!playerResponse.ok) {\r\n    return { title: oEmbedTitle, description: \"\", isFallback: true };\r\n  }\r\n\r\n  const data = await playerResponse.json();\r\n  const title = data.videoDetails?.title || oEmbedTitle;\r\n  const description = data.videoDetails?.shortDescription || \"\";\r\n\r\n  // 3. Extract transcript\r\n  const captionTracks: CaptionTrack[] | undefined =\r\n    data.captions?.playerCaptionsTracklistRenderer?.captionTracks;\r\n\r\n  if (!captionTracks || captionTracks.length === 0) {\r\n    return { title, description, isFallback: true };\r\n  }\r\n\r\n  try {\r\n    const enTrack =\r\n      captionTracks.find((t) => t.languageCode === \"en\") ||\r\n      captionTracks.find((t) => t.languageCode?.startsWith(\"en\")) ||\r\n      captionTracks[0];\r\n\r\n    if (!enTrack?.baseUrl) {\r\n      return { title, description, isFallback: true };\r\n    }\r\n\r\n    const captionResponse = await fetch(enTrack.baseUrl);\r\n    if (!captionResponse.ok) {\r\n      return { title, description, isFallback: true };\r\n    }\r\n\r\n    const xml = await captionResponse.text();\r\n    if (!xml || xml.length === 0) {\r\n      return { title, description, isFallback: true };\r\n    }\r\n\r\n    let segments: string[] = [];\r\n    const textMatches = xml.match(/<text[^>]*>([^<]*)<\\/text>/g);\r\n    if (textMatches && textMatches.length > 0) {\r\n      segments = textMatches.map((seg) => {\r\n        const m = seg.match(/<text[^>]*>([^<]*)<\\/text>/);\r\n        return m ? decodeHtmlEntities(m[1]) : \"\";\r\n      });\r\n    }\r\n\r\n    if (segments.length === 0) {\r\n      const pMatches = xml.match(/<p[^>]*>([^<]*)<\\/p>/g);\r\n      if (pMatches && pMatches.length > 0) {\r\n        segments = pMatches.map((seg) => {\r\n          const m = seg.match(/<p[^>]*>([^<]*)<\\/p>/);\r\n          return m ? decodeHtmlEntities(m[1]) : \"\";\r\n        });\r\n      }\r\n    }\r\n\r\n    if (segments.length === 0) {\r\n      return { title, description, isFallback: true };\r\n    }\r\n\r\n    const transcript = segments.filter((t) => t !== \"\").join(\" \");\r\n\r\n    if (!transcript.trim()) {\r\n      return { title, description, isFallback: true };\r\n    }\r\n\r\n    return { title, description, transcript, isFallback: false };\r\n  } catch (err) {\r\n    console.error(\"Transcript processing failed:\", err);\r\n    return { title, description, isFallback: true };\r\n  }\r\n}\r\n\r\nasync function summarizeWithGemini(metadata: VideoMetadata): Promise<string> {\r\n  const apiKey = process.env.GEMINI_API_KEY;\r\n  if (!apiKey) {\r\n    // Fallback for development if not set\r\n    if (process.env.NODE_ENV === \"development\") {\r\n      console.warn(\"GEMINI_API_KEY not set. Using mock response.\");\r\n      // throw new Error('GEMINI_API_KEY is not configured');\r\n    }\r\n    throw new Error(\"GEMINI_API_KEY is not configured\");\r\n  }\r\n\r\n  const genAI = new GoogleGenerativeAI(apiKey);\r\n  // Updated models list\r\n  const models = [\"gemini-1.5-flash\", \"gemini-1.5-pro\", \"gemini-pro\"];\r\n\r\n  let context = \"\";\r\n  if (metadata.isFallback) {\r\n    context = `The exact transcript for this video is currently unavailable due to data restrictions. \r\nHowever, we know the video is titled: \"${metadata.title}\".\r\nDescription: ${metadata.description}\r\n\r\nPlease use your extensive knowledge of the web and this specific YouTube video to generate comprehensive, highly accurate study notes as if you had read the transcript.`;\r\n  } else {\r\n    context = `**Video Title:** ${metadata.title}\r\n**Transcript:**\r\n${metadata.transcript?.substring(0, 30000)}`;\r\n  }\r\n\r\n  const prompt = `You are an expert study notes generator. Analyze the following video information and create comprehensive, well-structured study notes.\r\n\r\n${context}\r\n\r\n---\r\n\r\nGenerate the output in the following format (use plain text with markdown-like formatting):\r\n\r\n## ðŸ“Œ Video Summary\r\nWrite a concise 3-4 sentence summary of the video's main message.\r\n\r\n## ðŸŽ¯ Key Takeaways\r\n- List 5-8 key points from the video\r\n- Each point should be clear and actionable\r\n\r\n## ðŸ“ Detailed Study Notes\r\n\r\n### Topic 1: [Name]\r\n- Detailed explanation\r\n- Sub-points with examples\r\n\r\n### Topic 2: [Name]\r\n- Continue for all major topics covered\r\n\r\n## ðŸ’¡ Important Quotes or Facts\r\n- List any notable quotes, statistics, or facts mentioned\r\n\r\n## ðŸ”— Related Topics to Explore\r\n- Suggest 3-5 related topics the viewer might want to study next\r\n\r\nMake the notes clear, concise, and student-friendly. Use bullet points for readability.`;\r\n\r\n  for (const modelName of models) {\r\n    try {\r\n      const model = genAI.getGenerativeModel({ model: modelName });\r\n      const result = await model.generateContent(prompt);\r\n      const response = result.response;\r\n      return response.text();\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : \"\";\r\n      if (\r\n        message.includes(\"429\") ||\r\n        message.includes(\"quota\") ||\r\n        message.includes(\"not found\")\r\n      ) {\r\n        console.log(`Model ${modelName} issue (${message}), trying next...`);\r\n        // await new Promise(resolve => setTimeout(resolve, 2000));\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  throw new Error(\"All AI models failed or rate-limited. Please try again.\");\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { url, videoId: rawVideoId } = body;\r\n\r\n    // Support both source 'url' and target 'videoId' input\r\n    let videoId = rawVideoId;\r\n    if (url) {\r\n      const extracted = extractVideoId(url);\r\n      if (extracted) videoId = extracted;\r\n    }\r\n\r\n    if (!videoId && !url) {\r\n      return NextResponse.json(\r\n        { error: \"YouTube URL is required\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    // Final check\r\n    if (!videoId) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Invalid YouTube URL. Please paste a valid YouTube video link.\",\r\n        },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    // Extract metadata and transcript\r\n    const videoData = await getTranscript(videoId);\r\n\r\n    // Generate study notes\r\n    const notes = await summarizeWithGemini(videoData);\r\n\r\n    return NextResponse.json({\r\n      title: videoData.title,\r\n      videoId,\r\n      notes,\r\n      isFallback: videoData.isFallback,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"AI Summarize error:\", error);\r\n    const message =\r\n      error instanceof Error ? error.message : \"Failed to generate notes\";\r\n    return NextResponse.json({ error: message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}